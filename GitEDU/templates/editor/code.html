{% extends 'base.html' %}

{% block title %}Editar Codigo en Linea{% endblock %}

{% block content %}
    {% load static %}
    <div id="panel-de-control">
        <h2 id="title" class=" navbar-custom ">Codigo</h2>
        <h3>Por <a href="/user/{{ owner }}/">{{ owner }}</a></h3>
        <hr>
        <h3>Permisos Globales</h3>
        {% if new %}
            <h4>Valores por Defecto:</h4>
            <p>Editarlos no tendra efecto. Podrá editarlos despues de crear el codigo.</p>
        {% endif %}
        {% if orig %}
            <pre>
                 {% comment %} <form method="post" {% if not new %}action="{% url 'global-perms-code' id %}{% endif %}">
            {% csrf_token %}
                 <table class="permisos" style="padding: 0.8%">
                     {{ globalPermForm.as_table  }}
                 </table>

                     {% if not new %}
                         <button class="btn btn-successt" type="submit">Guardar</button>
                     {% endif %}
        </form> {% endcomment %}
              </pre>
            <hr/>
        {% endif %}

        <hr>
        {% comment %}<form action="" method="post" id="code-meta-data-form">{% endcomment %}
        <form id="code-meta-data-form" method="post">
            {% comment %}
            <script type="text/javascript">
                $('#code-meta-data-form').submit(function () {

                    var url = document.location;

                    $.ajax({
                        type: "POST",
                        url: url,
                        data: $(this).serialize(),
                        success: function (data) {
                            alert(data);
                        }
                    });

                    e.preventDefault();
                });
            </script>
            {% endcomment %}
            <style type="text/css" media="screen">
                #panel-de-control {
                    width: 45%;
                }

                #editor {
                    margin: 0;
                    position: fixed;
                    float: right;
                    top: 0;
                    bottom: 0;
                    left: 50%;
                    right: 0;
                    z-index: 0;
                }

                #code-meta-data {
                    margin: 0;
                    margin-right: 5%;
                    margin-bottom: 5%;
                    position: fixed;
                    float: right;
                    bottom: 0;
                    left: 60%;
                    width: 40%;
                    right: 0;
                    z-index: 1;
                    color: #fff;
                }

                .code-meta-data-field {
                    display: inline-flex;
                }

                #code-meta-data-form input,select {
                    background: transparent;
                    border: none;
                    color: #fff;
                }

                .code-meta-data-field-spacer {
                    margin-left: 0.5%;
                }
            </style>
            <div id="code-meta-data">
            {% csrf_token %}
            {% for field in form %}
                <div class="code-meta-data-field">
                    {{ field.errors }}
                    {% if field.errors %}
                        <div class="code-meta-data-field-spacer"></div>
                    {% endif %}
                    {{ field.label_tag }}
                    {% if field.label_tag %}
                        <div class="code-meta-data-field-spacer"></div>
                    {% endif %}
                    {% if field == form.language %}
                        <select id="{{ field.id_for_label }}" name="{{ field.html_name }}">
                            {% for id,name in form.fields.language.choices %}
                                <option value="{{ id }}" {% if field.value == id %}
                                        selected {% endif %}> {{ name }}
                                </option>
                            {% endfor %}
                        </select>
                    {% else %}
                        {{ field }}
                    {% endif %}
                    <div class="code-meta-data-field-spacer"></div>
                </div>
            {% endfor %}
            </div>

            <div id="editor" contenteditable="true" name="editor">{% if form.code.value is not None %}{{ form.code.value }}{% endif %}</div>
            {% comment %}<button class="btn btn-success btn-lg" type="submit" id="save" name="save">Guardar</button>{% endcomment %}
            <a class="btn btn-success btn-lg" id="save" name="save">Guardar</a>
            {% if represents_change %}
                <a class="btn btn-success btn-lg"
                   href="{% url 'ide:checkout' namespace=namespace repository=repository change=change_id %}">
                    Utilizar esta version
                </a>
            {% else %}
                {% if logged_in %}
                    <a class="btn btn-success btn-lg" id="execute">Ejecutar</a>
                {% endif %}
            {% endif %}
            <script type="text/javascript">
                function save_code(url) {
                    var save = $.ajax({
                        type: "POST",
                        url: url,
                        data: $("#code-meta-data-form").serialize(),
                        done: function (data) {
                            alert("Codigo Guardado Exitosamente!");
                        },
                        fail: function () {
                            alert("Error al Guardar...");
                        }
                    });
                    return save;
                }
                function execute_code() {
                    alert("Executing...");
                    var exec_id = "";
                    var exec = $.getJSON(
                        "{% url 'ide:repository_execution' namespace=namespace repository=repository %}"
                        ).done(function (json) {
                            alert(json);
                            console.log(json)
                            exec_id = json['id'];
                            console.log(exec_id);
                            //alert("Done: ".concat(exec_id));
                        }).fail(function (jqxhr, textStatus, error) {
                            var err = textStatus + ", " + error;
                            console.log( "AJAX Fallido: " + err );
                            alert("Ejecucion Fallo, ver log para detalles")
                    });
                    return exec;
                }
                $(function () {
                    $('#save').click(function () {
                        var editor = ace.edit("editor");
                        var mysave = editor.getValue();
                        $('#{{form.code.auto_id}}').val(mysave);
                        var url = document.location;
                        save_code(url); //.done(alert("Save All Done"));
                    });
                });
                {% if not represents_change and logged_in %}
                    $(function () {
                        $('#execute').click(function () {
                            var save_url = document.location;
                            save_code(save_url).done(execute_code());
                            /*.done(function () {
                                alert("Save + Execute Done!");
                            });*/
                        });
                    });
                {% endif %}
            </script>


            <script src="{% static 'js/ace/src-noconflict/ace.js' %}" type="text/javascript" charset="utf-8"></script>
            <script>
                //var editor = ace.edit("{{form.code.id_for_label}}");
                var editor = ace.edit("editor");
                editor.setTheme("ace/theme/twilight");

                var langs ={{ editorLang|safe }};
                //editor.session.setMode("ace/mode/python");// consta.editor_laguage[valordebase usercode.language]['ace']

                editor.session.setMode("ace/mode/" + {% if not new %}langs['{{ form.language.value }}']['ace']{% else %}"python"{% endif %}); // consta.editor_laguage[valordebase usercode.language]['ace']

                editor.setVisible(true);
            </script>
            <script type="application/javascript">
                $("#{{ form.language.id_for_label }}").change(function () {
                    var valor = $("#{{ form.language.id_for_label }}").val();
                    var editor = ace.edit("editor");
                    var langs ={{ editorLang|safe }};
                    editor.session.setMode("ace/mode/" + langs[valor]['ace']);
                });
            </script>
        </form>
        {% if not new %}
            {% if orig %}
                <h3 id="title" class=" navbar-custom ">Ediciones:</h3>
                <ol>
                    {% for e in edits %}
                        <li>
                            <a class="formularios"
                               href="{% url 'ide:change_file_editor' namespace=e.namespace repository=e.repository change=e.id file_path=e.file_path %}">
                                {{ e.id }}
                            </a> - <a class="formularios" href="{% url 'ide:namespace' namespace=e.namespace %}">
                                {{ e.namespace }}
                            </a> - <a class="formularios" href="{% url 'ide:repository' namespace=e.namespace repository=e.repository %}">
                                {{ e.repository }}
                            </a> - <a class="formularios"
                                      href="{% url 'ide:file_editor' namespace=e.namespace repository=e.repository file_path=e.file_path %}">
                                {{ e.file_path }}
                            </a>
                            <ul>
                                <li>
                                    Por: <a class="formularios" href="{% url "social:user" user=e.author %}">
                                        {{ e.author }}
                                    </a>
                                </li>
                                <li>{{ e.timestamp }}</li>
                            </ul>
                        </li>
                    {% endfor %}
                </ol>
                <hr>
                <h3 id="title" class=" navbar-custom ">Colaboradores</h3>
                {% comment %}
                <a href="{% url 'collab-perms-code' id %}">Ver</a>
                {% endcomment %}
                <h4>Agregar Colaborador</h4>
                {% comment %}
                <form method="post" action="{% url 'new-collab-perms-code' id %}">
                    {% csrf_token %}
                    <table style="text-align: left">
                    {{ collabForm.as_table }}
                        </table>
                    <button class="btn btn-success btn-lg" type="submit">Agregar Colaborador</button>
                </form>
                {% endcomment %}
                <hr>
                {% comment %}
                <script src="https://togetherjs.com/togetherjs-min.js"></script>
                <!--button onclick="TogetherJS(this); return false;">Empezar Sesion de TogetherJS</button-->
                <script>
                    $(document).ready(function () {
                        TogetherJS(this);
                        return false;
                    });
                </script>
                {% endcomment %}
            {% else %}
                <h3 id="title" class=" navbar-custom ">Modificó:</h3>
                <p><a href="/code/{{ original.code_id }}/">{{ original.file_name }}</a></p>
                <p>{{ thisEdit.timestamp }}</p>
                <p><a href="/user/{{ modifiedBy.username }}/">{{ modifiedBy.username }}</a></p>
            {% endif %}
        {% endif %}
    </div>
{% endblock %}